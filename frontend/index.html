<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Berlin E-Scooter Demand Heatmap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f8;
      color: #1f3b4d;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: #1e3a5f;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      background-color: #e2e8f0;
      padding: 2rem;
      width: 300px;
      box-shadow: 2px 0 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      /* Neu: Scrollbar f√ºr Sidebar */
      max-height: 100vh;
      overflow-y: auto;
    }
    .sidebar label {
      margin: 0.5rem 0 0.2rem;
    }
    .sidebar input, .sidebar select {
      margin-bottom: 1rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .sidebar #hour-label {
      font-weight: bold;
    }
    #map {
      flex: 1;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    svg {
      max-width: 100%;
      height: auto;
    }
    .tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      font-size: 14px;
    }
    /* Modal zentriert und sch√∂ner */
    #event-modal {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.3);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #event-form {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      align-items: stretch;
    }
    #event-form label {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-weight: 500;
    }
    #event-form input, #event-form select {
      margin-bottom: 0;
      padding: 0.5rem 0.7rem;
      border-radius: 5px;
      border: 1px solid #bfc8d4;
      font-size: 1rem;
    }
    #event-form h3 {
      margin-bottom: 0.5rem;
      text-align: center;
    }
    #event-form div[style*="justify-content:flex-end"] {
      margin-top: 0.5rem;
    }

    /* Event-Boxen in der Sidebar */
    #event-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .event-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(30,58,95,0.08);
      padding: 0.8rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      border-left: 4px solid #3b82f6;
      position: relative;
    }
    .event-box strong {
      font-size: 1.08em;
      color: #1e3a5f;
    }
    .event-box em {
      color: #64748b;
      font-style: normal;
      font-size: 0.98em;
    }
    .event-box .delete-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.7rem;
      background: none;
      border: none;
      color: #ef4444;
      font-size: 1.1em;
      cursor: pointer;
      padding: 0;
    }
    .event-box .delete-btn:hover {
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <header>
    <h1>Berlin E-Scooter Demand Heatmap</h1>
  </header>
  <main>
    <div class="sidebar">
      <label for="date">Date:</label>
      <input type="date" id="date" value="2025-06-28">

      <label for="weather">Weather:</label>
      <select id="weather">
        <option value="sunny">Sonnig</option>
        <option value="cloudy">Bew√∂lkt</option>
        <option value="windy">Windig</option>
        <option value="rainy">Regen</option>
      </select>

      <label for="hour">Hour:</label>
      <input type="range" id="hour" min="0" max="23" value="12">
      <span id="hour-label">12:00</span>

      <h3>Events</h3>
      <ul id="event-list"></ul>
    </div>

    <div id="map"></div>
    <div class="tooltip" id="tooltip" style="display:none;"></div>

    <!-- Event Modal -->
    <div id="event-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center; z-index:1000;">
      <form id="event-form" style="background:white; padding:2rem; border-radius:8px; min-width:300px; display:flex; flex-direction:column; gap:1rem; box-shadow:0 2px 12px rgba(0,0,0,0.2);">
        <h3 id="event-modal-title"></h3>
        <label>Name: <input type="text" id="event-name" required></label>
        <label>Teilnehmeranzahl: <input type="number" id="event-participants" min="1" required></label>
        <label>Kategorie:
          <select id="event-category" required>
            <option value="Musik">Musik</option>
            <option value="Sport">Sport</option>
            <option value="Politik">Politik</option>
            <option value="Kultur">Kultur</option>
          </select>
        </label>
        <div style="display:flex; gap:1rem; justify-content:flex-end;">
          <button type="button" id="event-cancel">Abbrechen</button>
          <button type="submit">Speichern</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    const berlinDistricts = [
  "Mitte", "Friedrichshain", "Kreuzberg", "Prenzlauer Berg",
  "Neuk√∂lln", "Spandau", "Marzahn", "Lichtenberg",
  "Reinickendorf", "Treptow"
  ];

    const colorScale = d3.scaleSequential()
      .domain([0, 150])
      .interpolator(d3.interpolateBlues);

    const tooltip = d3.select("#tooltip");
    const width = 800, height = 600;
    const svg = d3.select("#map")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .call(d3.zoom().on("zoom", (event) => {
        svg.select("g").attr("transform", event.transform);
      }));
    const g = svg.append("g");

    const projection = d3.geoMercator()
      .center([13.4, 52.52])
      .scale(40000)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    document.getElementById("hour").addEventListener("input", e => {
      document.getElementById("hour-label").textContent = `${e.target.value}:00`;
      updateMap();
    });
    document.getElementById("date").addEventListener("change", updateMap);
    document.getElementById("weather").addEventListener("change", updateMap);

    let currentDemandData = {};
    let events = [];

    // Event Modal Logic
    const eventModal = document.getElementById("event-modal");
    const eventForm = document.getElementById("event-form");
    const eventNameInput = document.getElementById("event-name");
    const eventParticipantsInput = document.getElementById("event-participants");
    const eventCategoryInput = document.getElementById("event-category");
    const eventModalTitle = document.getElementById("event-modal-title");
    let selectedDistrict = null;

    function openEventModal(district) {
      selectedDistrict = district;
      eventModalTitle.textContent = `Event in ${district}`;
      eventNameInput.value = "";
      eventParticipantsInput.value = "";
      eventCategoryInput.value = "Musik";
      eventModal.style.display = "flex";
    }

    function closeEventModal() {
      eventModal.style.display = "none";
      selectedDistrict = null;
    }

    eventForm.addEventListener("submit", function(e) {
      e.preventDefault();
      events.push({
        district: selectedDistrict,
        name: eventNameInput.value,
        participants: parseInt(eventParticipantsInput.value),
        category: eventCategoryInput.value
      });
      closeEventModal();
      renderEventList();
      updateMap();
    });

    document.getElementById("event-cancel").onclick = closeEventModal;

    function renderEventList() {
      const ul = document.getElementById("event-list");
      ul.innerHTML = "";
      events.forEach((ev, idx) => {
        const li = document.createElement("li");
        li.className = "event-box";
        li.innerHTML = `
          <button class="delete-btn" title="L√∂schen" data-idx="${idx}">üóëÔ∏è</button>
          <strong>${ev.name}</strong>
          <span>${ev.category}, ${ev.participants} TN</span>
          <em>${ev.district}</em>
        `;
        li.querySelector(".delete-btn").onclick = function() {
          events.splice(idx, 1);
          renderEventList();
          updateMap(); // Heatmap nach Entfernen aktualisieren
        };
        ul.appendChild(li);
      });
    }

    function getWochentag(dateStr) {
      const dt = new Date(dateStr);
      return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][dt.getDay()];
    }

    function getJahreszeit(month) {
      if ([12, 1, 2].includes(month)) return "Winter";
      if ([3, 4, 5].includes(month)) return "Fr√ºhling";
      if ([6, 7, 8].includes(month)) return "Sommer";
      return "Herbst";
    }

    function isHoliday(dateStr) {
      const dt = new Date(dateStr);
      return dt.getDay() === 0 || dt.getDay() === 6; // So & Sa als "Feiertag"
    }

    async function fetchRealDemand(date, hour, weather) {
      const dt = new Date(date);
      const body = {
        wochentag: getWochentag(date),
        jahreszeit: getJahreszeit(dt.getMonth() + 1),
        wetter: { sunny: "Sonnig", rainy: "Regen", cloudy: "Bew√∂lkt", windy: "Windig" }[weather],
        event_art: "Musik",
        feiertag: isHoliday(date),
        stunde: hour,
        events
      };

      try {
        const res = await fetch("http://localhost:8000/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        return await res.json();
      } catch (err) {
        console.error("API error", err);
        return {};
      }
    }

    async function updateMap() {
      const date = document.getElementById("date").value;
      const hour = parseInt(document.getElementById("hour").value);
      const weather = document.getElementById("weather").value;

      currentDemandData = await fetchRealDemand(date, hour, weather);

      g.selectAll("path")
        .transition()
        .duration(300)
        .attr("fill", d => {
          const name = d.properties.name;
          return berlinDistricts.includes(name)
            ? colorScale(currentDemandData[name] || 0)
            : "#eee";
        });
    }

    d3.json("https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/berlin.geojson")
      .then(geoData => {
        g.selectAll("path")
          .data(geoData.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("stroke", "#1f3b4d")
          .attr("fill", d => {
            const name = d.properties.name;
            return berlinDistricts.includes(name) ? colorScale(0) : "#eee";
          })
          .on("mouseover", (event, d) => {
            const name = d.properties.name;
            if (!berlinDistricts.includes(name)) return;
            const demand = currentDemandData[name] || 0;
            tooltip
              .style("display", "block")
              .html(`<strong>${name}</strong><br>Nachfrage: ${demand}`);
          })
          .on("mousemove", (event) => {
            tooltip.style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 20) + "px");
          })
          .on("mouseout", () => tooltip.style("display", "none"))
          .on("click", (event, d) => {
            const name = d.properties.name;
            if (!berlinDistricts.includes(name)) return;
            openEventModal(name);
          });

        updateMap();
      });
  </script>
</body>
</html>
